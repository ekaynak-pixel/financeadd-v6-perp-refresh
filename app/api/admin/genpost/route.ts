import {NextRequest,NextResponse} from 'next/server';import {getDB} from '../../../../lib/db';import slugify from 'slugify';import {pingIndexNow} from '../../../../lib/indexnow';import {gzipSync} from 'zlib';export const runtime='nodejs';
export async function POST(req:NextRequest){const {kw}=await req.json();if(!kw) return NextResponse.json({error:'Missing keyword'},{status:400});const db=getDB();const prov=db.prepare('SELECT * FROM api_keys WHERE enabled=1 ORDER BY priority ASC LIMIT 1').get();const base=prov?.base_url||'https://openrouter.ai/api/v1/chat/completions';const header=(prov?.header_name||'Authorization');const key=prov?.api_key||(process.env.OPENROUTER_API_KEY?`Bearer ${process.env.OPENROUTER_API_KEY}`:'');if(!key) return NextResponse.json({error:'No AI provider configured'},{status:400});
const prompt=`Write an expert-level, SEO-optimized finance article in US English targeting: "${kw}".\n- E-E-A-T; provide H2/H3s, FAQs, meta description (<155 chars), and cite reputable sources with links.\n- Output markdown only under 1200 words.`;
const r=await fetch(base,{method:'POST',headers:{'Content-Type':'application/json',[header]:key},body:JSON.stringify({model:prov?.model||process.env.OPENROUTER_MODEL||'openrouter/auto',messages:[{role:'system',content:'You are an elite SEO content strategist and finance writer. Output only markdown.'},{role:'user',content:prompt}],temperature:0.5})});if(!r.ok) return NextResponse.json({error:'Provider error: '+r.status},{status:502});const data=await r.json();const content=data?.choices?.[0]?.message?.content||`# ${kw}\nDraft`;const titleLine=content.split('\n').find((l:string)=>l.startsWith('# '));const title=titleLine?titleLine.replace(/^# /,'').trim():kw;const slug=slugify(title,{lower:true,strict:true});const compressed=gzipSync(Buffer.from(content,'utf-8'));db.prepare('INSERT OR REPLACE INTO posts (id,slug,title,content_compressed,created_at) VALUES (?,?,?,?,?)').run(globalThis.crypto?.randomUUID?.()||String(Math.random()),slug,title,compressed,Date.now());await pingIndexNow([`${process.env.SITE_URL||'https://financeadd.com'}/blog/${slug}`]);return NextResponse.json({ok:true,message:`Published /blog/${slug}`})}
